name: ðŸ”¥ Worker Sentinel ULTIMATE

on:
  repository_dispatch:
    types: [scan_target]
  workflow_dispatch:
    inputs:
      target:
        description: 'Target domain'
        required: true
        type: string
      intensity:
        description: 'Scan intensity (1-3)'
        required: false
        default: '2'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
      enable_ai:
        description: 'Enable AI Analysis'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
      - name: ðŸŽ¯ Get Target
        id: target
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            TARGET="${{ github.event.client_payload.target }}"
            INTENSITY="${{ github.event.client_payload.intensity }}"
            ENABLE_AI="${{ github.event.client_payload.enable_ai }}"
          else
            TARGET="${{ github.event.inputs.target }}"
            INTENSITY="${{ github.event.inputs.intensity }}"
            ENABLE_AI="${{ github.event.inputs.enable_ai }}"
          fi
          echo "target=$TARGET" >> $GITHUB_OUTPUT
          echo "intensity=${INTENSITY:-2}" >> $GITHUB_OUTPUT
          echo "enable_ai=${ENABLE_AI:-true}" >> $GITHUB_OUTPUT
          echo "ðŸŽ¯ Target: $TARGET | Intensity: ${INTENSITY:-2} | AI: ${ENABLE_AI:-true}"
      
      - name: ðŸ”§ Install Tools
        run: |
          wget -q https://go.dev/dl/go1.21.0.linux-amd64.tar.gz
          sudo tar -C /usr/local -xzf go1.21.0.linux-amd64.tar.gz
          export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin
          echo "PATH=$PATH:/usr/local/go/bin:$HOME/go/bin" >> $GITHUB_ENV
          
          go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest &
          go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest &
          go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest &
          go install -v github.com/projectdiscovery/katana/cmd/katana@latest &
          wait
          
          echo "âœ… Tools installed"
      
      - name: ðŸ” Subdomain Discovery
        id: subdomains
        run: |
          TARGET="${{ steps.target.outputs.target }}"
          INTENSITY="${{ steps.target.outputs.intensity }}"
          
          if [ "$INTENSITY" -ge "3" ]; then
            TIMEOUT=10
          elif [ "$INTENSITY" -ge "2" ]; then
            TIMEOUT=5
          else
            TIMEOUT=3
          fi
          
          subfinder -d $TARGET -silent -max-time $TIMEOUT -o subs.txt 2>/dev/null || echo "$TARGET" > subs.txt
          
          # Add target itself if not found
          echo "$TARGET" >> subs.txt
          echo "www.$TARGET" >> subs.txt
          
          sort -u subs.txt -o subs.txt
          COUNT=$(wc -l < subs.txt)
          echo "âœ… Subdomains: $COUNT"
          echo "count=$COUNT" >> $GITHUB_OUTPUT
      
      - name: ðŸŒ HTTP Probing
        id: http
        run: |
          INTENSITY="${{ steps.target.outputs.intensity }}"
          
          if [ "$INTENSITY" -ge "3" ]; then
            THREADS=50
          elif [ "$INTENSITY" -ge "2" ]; then
            THREADS=30
          else
            THREADS=20
          fi
          
          cat subs.txt | httpx -silent -timeout 10 -threads $THREADS -follow-redirects -o live.txt 2>/dev/null || cp subs.txt live.txt
          
          # If no live hosts, try adding http/https
          if [ ! -s live.txt ]; then
            TARGET="${{ steps.target.outputs.target }}"
            echo "http://$TARGET" > live.txt
            echo "https://$TARGET" >> live.txt
          fi
          
          COUNT=$(wc -l < live.txt)
          echo "âœ… Live hosts: $COUNT"
          echo "count=$COUNT" >> $GITHUB_OUTPUT
      
      - name: ðŸ•·ï¸ Crawling & URL Discovery
        id: crawl
        run: |
          INTENSITY="${{ steps.target.outputs.intensity }}"
          
          if [ "$INTENSITY" -ge "3" ]; then
            DEPTH=3
          elif [ "$INTENSITY" -ge "2" ]; then
            DEPTH=2
          else
            DEPTH=1
          fi
          
          cat live.txt | head -5 | katana -silent -depth $DEPTH -timeout 10 -o urls.txt 2>/dev/null || cp live.txt urls.txt
          
          COUNT=$(wc -l < urls.txt)
          echo "âœ… URLs discovered: $COUNT"
          echo "count=$COUNT" >> $GITHUB_OUTPUT
      
      - name: ðŸ”Ž Nuclei Scan
        id: nuclei
        run: |
          INTENSITY="${{ steps.target.outputs.intensity }}"
          
          nuclei -update-templates -silent 2>/dev/null || true
          
          if [ "$INTENSITY" -ge "3" ]; then
            SEV="critical,high,medium,low,info"
            RATE=150
          elif [ "$INTENSITY" -ge "2" ]; then
            SEV="critical,high,medium"
            RATE=100
          else
            SEV="critical,high"
            RATE=50
          fi
          
          cat live.txt | nuclei -silent -severity $SEV -timeout 15 -rate-limit $RATE -json -o nuclei.json 2>/dev/null || touch nuclei.json
          cat live.txt | nuclei -silent -severity $SEV -timeout 15 -rate-limit $RATE -o results.txt 2>/dev/null || touch results.txt
          
          COUNT=$(wc -l < results.txt)
          echo "âœ… Nuclei findings: $COUNT"
          echo "count=$COUNT" >> $GITHUB_OUTPUT
      
      - name: ðŸ¤– AI Analysis & Send Reports
        run: |
          TARGET="${{ steps.target.outputs.target }}"
          SUBS="${{ steps.subdomains.outputs.count }}"
          LIVE="${{ steps.http.outputs.count }}"
          URLS="${{ steps.crawl.outputs.count }}"
          VULN="${{ steps.nuclei.outputs.count }}"
          ENABLE_AI="${{ steps.target.outputs.enable_ai }}"
          
          # ONLY send notification if vulnerabilities found
          if [ "$VULN" -gt "0" ]; then
            # Send summary alert
            curl -H "Content-Type: application/json" \
                 -d '{
                   "embeds": [{
                     "title": "ðŸš¨ Vulnerabilities Found!",
                     "description": "**Target:** '"$TARGET"'\n**Vulnerabilities:** '"$VULN"'",
                     "color": 15158332,
                     "fields": [
                       {"name": "ðŸ” Subdomains", "value": "'"$SUBS"'", "inline": true},
                       {"name": "ðŸŒ Live", "value": "'"$LIVE"'", "inline": true},
                       {"name": "ðŸ•·ï¸ URLs", "value": "'"$URLS"'", "inline": true},
                       {"name": "ðŸ› Findings", "value": "'"$VULN"'", "inline": true}
                     ],
                     "footer": {"text": "Digital Sentinel ULTIMATE | '"$(date)"'"}
                   }]
                 }' \
                 ${{ secrets.DISCORD_WEBHOOK_URL }} 2>/dev/null || true
            
            sleep 2
            
            # Send detailed vulnerability reports with AI analysis
            if [ -f nuclei.json ] && [ -s nuclei.json ]; then
              while IFS= read -r line; do
                VULN_NAME=$(echo "$line" | jq -r '.info.name // "Unknown"')
                VULN_SEVERITY=$(echo "$line" | jq -r '.info.severity // "info"' | tr '[:lower:]' '[:upper:]')
                VULN_TYPE=$(echo "$line" | jq -r '.info.tags[0] // "unknown"')
                VULN_URL=$(echo "$line" | jq -r '."matched-at" // .host // "Unknown"')
                VULN_DESC=$(echo "$line" | jq -r '.info.description // "No description"' | head -c 500)
                VULN_CVSS=$(echo "$line" | jq -r '.info.classification."cvss-score" // "N/A"')
                VULN_CWE=$(echo "$line" | jq -r '.info.classification."cwe-id"[0] // ""')
                MATCHER=$(echo "$line" | jq -r '."matcher-name" // "N/A"')
                CURL_CMD=$(echo "$line" | jq -r '."curl-command" // "N/A"' | head -c 500)
                EXTRACTED=$(echo "$line" | jq -r '.["extracted-results"][0] // "N/A"' | head -c 200)
                
                case "$VULN_SEVERITY" in
                  CRITICAL) SEVERITY_COLOR=10038562 ;;
                  HIGH) SEVERITY_COLOR=15158332 ;;
                  MEDIUM) SEVERITY_COLOR=16098851 ;;
                  LOW) SEVERITY_COLOR=16776960 ;;
                  *) SEVERITY_COLOR=9807270 ;;
                esac
                
                # AI Analysis using Gemini
                AI_ANALYSIS="N/A"
                if [ "$ENABLE_AI" == "true" ] && [ -n "${{ secrets.GEMINI_API_KEY }}" ]; then
                  AI_PROMPT="Analyze this vulnerability for bug bounty submission:
Name: $VULN_NAME
Type: $VULN_TYPE
Severity: $VULN_SEVERITY
URL: $VULN_URL
Description: $VULN_DESC

Provide:
1. Impact assessment (2-3 sentences)
2. Exploitation difficulty (Easy/Medium/Hard)
3. Bug bounty value estimate (Low/Medium/High/Critical)
4. Key points for report"
                  
                  AI_RESPONSE=$(curl -s -X POST \
                    "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${{ secrets.GEMINI_API_KEY }}" \
                    -H "Content-Type: application/json" \
                    -d '{
                      "contents": [{
                        "parts": [{
                          "text": "'"${AI_PROMPT//\"/\\\"}"'"
                        }]
                      }],
                      "generationConfig": {
                        "temperature": 0.7,
                        "maxOutputTokens": 500
                      }
                    }' 2>/dev/null || echo "")
                  
                  if [ -n "$AI_RESPONSE" ]; then
                    AI_ANALYSIS=$(echo "$AI_RESPONSE" | jq -r '.candidates[0].content.parts[0].text // "N/A"' | head -c 800)
                  fi
                fi
                
                REPORT="**ðŸš¨ VULNERABILITY REPORT**\n\n"
                REPORT+="**ðŸ“‹ BASIC INFORMATION**\n"
                REPORT+="â€¢ Target: $TARGET\n"
                REPORT+="â€¢ Name: $VULN_NAME\n"
                REPORT+="â€¢ Type: $VULN_TYPE\n"
                REPORT+="â€¢ Severity: $VULN_SEVERITY\n"
                REPORT+="â€¢ CVSS: $VULN_CVSS\n"
                if [ -n "$VULN_CWE" ]; then
                  REPORT+="â€¢ CWE: CWE-$VULN_CWE\n"
                fi
                REPORT+="\n**ðŸ”— AFFECTED URL**\n$VULN_URL\n"
                REPORT+="\n**ðŸ“ DESCRIPTION**\n$VULN_DESC\n"
                REPORT+="\n**ðŸ” PROOF OF CONCEPT**\n"
                REPORT+="â€¢ Matcher: $MATCHER\n"
                if [ "$EXTRACTED" != "N/A" ]; then
                  REPORT+="â€¢ Extracted: \`$EXTRACTED\`\n"
                fi
                if [ "$CURL_CMD" != "N/A" ]; then
                  REPORT+="â€¢ cURL: \`${CURL_CMD:0:200}...\`\n"
                fi
                
                if [ "$AI_ANALYSIS" != "N/A" ]; then
                  REPORT+="\n**ðŸ¤– AI ANALYSIS**\n${AI_ANALYSIS:0:600}\n"
                fi
                
                REPORT+="\n**ðŸ’¡ REMEDIATION**\n"
                
                case "$VULN_TYPE" in
                  *xss*)
                    REPORT+="1. Input Validation: Validate and sanitize all user inputs\n"
                    REPORT+="2. Output Encoding: Encode output before rendering\n"
                    REPORT+="3. CSP: Implement Content Security Policy\n"
                    REPORT+="4. HTTPOnly: Set HTTPOnly flag on cookies"
                    ;;
                  *sql*)
                    REPORT+="1. Parameterized Queries: Use prepared statements\n"
                    REPORT+="2. Input Validation: Sanitize all inputs\n"
                    REPORT+="3. Least Privilege: Minimum database permissions\n"
                    REPORT+="4. WAF: Implement Web Application Firewall"
                    ;;
                  *rce*|*command*)
                    REPORT+="1. Input Validation: Strictly validate inputs\n"
                    REPORT+="2. Disable Functions: Disable dangerous functions\n"
                    REPORT+="3. Sandboxing: Run in sandboxed environment\n"
                    REPORT+="4. Update: Keep software updated"
                    ;;
                  *ssrf*)
                    REPORT+="1. Whitelist: Implement URL whitelist\n"
                    REPORT+="2. Network Segmentation: Isolate internal services\n"
                    REPORT+="3. Input Validation: Validate all URLs\n"
                    REPORT+="4. Disable Redirects: Disable automatic redirects"
                    ;;
                  *lfi*|*rfi*)
                    REPORT+="1. Path Validation: Validate file paths\n"
                    REPORT+="2. Whitelist: Use file whitelist\n"
                    REPORT+="3. Disable Functions: Disable include/require\n"
                    REPORT+="4. Chroot: Use chroot jail"
                    ;;
                  *)
                    REPORT+="1. Follow OWASP security best practices\n"
                    REPORT+="2. Regular security audits\n"
                    REPORT+="3. Keep software updated\n"
                    REPORT+="4. Security training for developers"
                    ;;
                esac
                
                REPORT+="\n\n**ðŸ“… METADATA**\n"
                REPORT+="â€¢ Discovered: $(date -u '+%Y-%m-%d %H:%M:%S UTC')\n"
                REPORT+="â€¢ Scanner: Digital Sentinel ULTIMATE v2.0\n"
                REPORT+="â€¢ Scan ID: ${{ github.run_id }}\n"
                REPORT+="â€¢ AI Enhanced: $ENABLE_AI\n"
                REPORT+="\nâš ï¸ **Ready for Bug Bounty Submission** âœ…"
                
                curl -H "Content-Type: application/json" \
                     -d '{
                       "embeds": [{
                         "title": "ðŸš¨ '"$VULN_NAME"'",
                         "description": "'"$(echo "$REPORT" | sed 's/"/\\"/g')"'",
                         "color": '"$SEVERITY_COLOR"',
                         "footer": {"text": "Digital Sentinel ULTIMATE | Bug Bounty Ready"},
                         "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
                       }]
                     }' \
                     ${{ secrets.DISCORD_WEBHOOK_URL }} 2>/dev/null || true
                
                sleep 2
              done < nuclei.json
            fi
          else
            echo "âœ… No vulnerabilities found - skipping Discord notification"
          fi
      
      - name: ðŸ“Š Summary
        run: |
          TARGET="${{ steps.target.outputs.target }}"
          SUBS="${{ steps.subdomains.outputs.count }}"
          LIVE="${{ steps.http.outputs.count }}"
          URLS="${{ steps.crawl.outputs.count }}"
          VULN="${{ steps.nuclei.outputs.count }}"
          ENABLE_AI="${{ steps.target.outputs.enable_ai }}"
          
          echo "## ðŸ”¥ Scan Complete: $TARGET" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” Subdomains: $SUBS" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ Live: $LIVE" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ•·ï¸ URLs: $URLS" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ› Vulnerabilities: $VULN" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ¤– AI Analysis: $ENABLE_AI" >> $GITHUB_STEP_SUMMARY
          
          if [ "$VULN" -gt "0" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“‹ **Detailed reports sent to Discord with AI analysis**" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **No vulnerabilities found - no Discord notification sent**" >> $GITHUB_STEP_SUMMARY
          fi
